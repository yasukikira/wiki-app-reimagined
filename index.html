<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- 1. Viewport & PWA Settings -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Wiki App</title>
    
    <!-- 2. Embedded App Icon (Blue 'W' Logo) -->
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAAsTAAALEwEAmpwYAAABmElEQVR42u2bzWoCQRCG+xQ+gU/iI3gHj+AbeAk/QPAWfAAfQPAQHgJ6CQRSCHQjhOSQHAJ5d9d0FzO7o7M9s8t+MDO19K/uquqqD0RERAQy1j+y+tJc4l+uC1z+4p+5wO4C94f45wKzC8wucI+Iv90F/iH+u8C8C8y7wLwLzLvAvAvMu8C8C8y7wLwLzLvAvAvM2wX+C/FfBeZ9F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYiIiIiIgIpPoC1d8+8/qrdHAAAAAASUVORK5CYII=">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAAsTAAALEwEAmpwYAAABmElEQVR42u2bzWoCQRCG+xQ+gU/iI3gHj+AbeAk/QPAWfAAfQPAQHgJ6CQRSCHQjhOSQHAJ5d9d0FzO7o7M9s8t+MDO19K/uquqqD0RERAQy1j+y+tJc4l+uC1z+4p+5wO4C94f45wKzC8wucI+Iv90F/iH+u8C8C8y7wLwLzLvAvAvMu8C8C8y7wLwLzLvAvAvM2wX+C/FfBeZ9F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYd4F5F5h3gXkXmHeBeReYiIiIiIgIpPoC1d8+8/qrdHAAAAAASUVORK5CYII=">

    <!-- Tailwind & Effects -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --accent: #2563eb;
            --accent-soft: #eff6ff;
            --font-serif: 'Merriweather', serif;
            
            /* Safe Area for Notches */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        [data-theme="dark"] {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #60a5fa;
            --accent-soft: #172554;
        }

        [data-theme="sepia"] {
            --bg-main: #f5e6d3;
            --bg-card: #fdf6e3;
            --text-primary: #433422;
            --text-secondary: #8b7d6b;
            --border: #e6dcc8;
            --accent: #d97706;
            --accent-soft: #fff7ed;
        }

        /* --- GLOBAL APP STYLES --- */
        html, body {
            height: 100%;
            width: 100%;
            overscroll-behavior-y: none; /* Prevents bounce */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            padding-top: var(--safe-top); /* Notch Support */
            padding-bottom: var(--safe-bottom);
        }

        /* App-like selection behavior */
        button, nav, .ui-element, summary {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(8px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* --- ARTICLE PANEL --- */
        #article-panel {
            position: fixed; top: 0; right: 0; bottom: 0;
            width: 100%; max-width: 900px;
            background: var(--bg-card);
            z-index: 50;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -10px 0 40px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            padding-top: var(--safe-top); /* Notch inside panel */
        }
        #article-panel.open { transform: translateX(0); }
        
        #overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #overlay.active { opacity: 1; pointer-events: auto; }

        /* --- CONTENT --- */
        .wiki-content { font-family: var(--font-serif); font-size: 1.15rem; line-height: 1.85; }
        .wiki-content p { margin-bottom: 1.5rem; }
        .wiki-content a { color: var(--accent); text-decoration: none; border-bottom: 1px solid transparent; font-weight: 500; }
        .wiki-content a:active { opacity: 0.6; }
        .wiki-content img { border-radius: 0.75rem; margin: 1.5rem auto; max-width: 100%; height: auto; display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* Accordions */
        details { border-bottom: 1px solid var(--border); }
        details > summary {
            list-style: none; padding: 1.2rem 0.5rem;
            font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.1rem;
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
            color: var(--text-primary); transition: background 0.2s;
        }
        details > summary:active { background: var(--bg-main); }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::after { content: '+'; font-size: 1.5rem; font-weight: 300; opacity: 0.6; transition: transform 0.2s; }
        details[open] > summary::after { transform: rotate(45deg); }
        .details-content { padding: 0.5rem 1rem 2rem 1rem; }

        /* Game HUD */
        #game-hud { background: linear-gradient(135deg, #2563eb, #4f46e5); color: white; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">
</head>
<body data-theme="light" class="antialiased">

    <!-- NAVBAR -->
    <nav class="sticky top-0 z-30 h-16 bg-[var(--bg-card)] border-b border-[var(--border)] flex items-center justify-between px-4 transition-colors ui-element">
        <div class="flex items-center gap-2 cursor-pointer active:scale-95 transition-transform" onclick="resetHome()">
            <div class="w-8 h-8 bg-[var(--accent)] text-white rounded-lg flex items-center justify-center font-bold shadow-lg">W</div>
            <span class="font-bold text-lg tracking-tight hidden sm:block">Wiki<span class="text-[var(--accent)]">App</span></span>
        </div>

        <div class="flex-1 max-w-xl mx-4 relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] w-4 h-4"></i>
            <input type="text" id="search-input" class="w-full pl-10 pr-4 py-2.5 bg-[var(--bg-main)] rounded-full border border-[var(--border)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition-colors placeholder-[var(--text-secondary)] text-[var(--text-primary)]" placeholder="Search..." autocomplete="off">
        </div>

        <div class="flex items-center gap-1">
            <button onclick="fetchRandom()" class="p-2.5 text-[var(--text-secondary)] hover:bg-[var(--bg-main)] active:bg-[var(--border)] rounded-full transition-colors" title="Random">
                <i data-lucide="dice-5" class="w-5 h-5"></i>
            </button>
            <button onclick="openGameMenu()" class="p-2.5 text-[var(--text-secondary)] hover:bg-[var(--bg-main)] active:bg-[var(--border)] rounded-full transition-colors" title="Game">
                <i data-lucide="gamepad-2" class="w-5 h-5"></i>
            </button>
            <button onclick="cycleTheme()" class="p-2.5 text-[var(--text-secondary)] hover:bg-[var(--bg-main)] active:bg-[var(--border)] rounded-full transition-colors" title="Theme">
                <i data-lucide="palette" class="w-5 h-5"></i>
            </button>
        </div>
    </nav>

    <!-- DASHBOARD -->
    <main id="main-view" class="max-w-7xl mx-auto p-4 lg:p-8">
        <div id="dashboard" class="space-y-8 fade-in">
            
            <!-- Featured Hero -->
            <section id="featured-section" class="hidden relative w-full h-80 rounded-3xl overflow-hidden shadow-xl cursor-pointer group active:scale-[0.99] transition-transform" onclick="openFeatured()">
                <img id="featured-img" src="" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                <div class="absolute bottom-0 left-0 p-6 md:p-8 max-w-3xl">
                    <div class="inline-flex items-center gap-2 px-3 py-1 bg-yellow-500/20 border border-yellow-500/50 rounded-full text-yellow-300 text-xs font-bold uppercase mb-3 backdrop-blur-md">
                        <i data-lucide="star" class="w-3 h-3"></i> Featured
                    </div>
                    <h1 id="featured-title" class="text-3xl md:text-5xl font-bold text-white mb-2 leading-tight"></h1>
                    <p id="featured-extract" class="text-slate-200 line-clamp-2"></p>
                </div>
            </section>

            <!-- Grids -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Trending -->
                <div class="lg:col-span-2">
                    <h3 class="flex items-center gap-2 text-sm font-bold text-[var(--text-secondary)] uppercase mb-4 ui-element">
                        <i data-lucide="trending-up" class="w-4 h-4"></i> Trending
                    </h3>
                    <div id="trending-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-full py-10 text-center opacity-50">Loading trends...</div>
                    </div>
                </div>
                <!-- On This Day -->
                <div>
                    <h3 class="flex items-center gap-2 text-sm font-bold text-[var(--text-secondary)] uppercase mb-4 ui-element">
                        <i data-lucide="calendar" class="w-4 h-4"></i> On This Day
                    </h3>
                    <div id="otd-list" class="bg-[var(--bg-card)] border border-[var(--border)] rounded-2xl p-2 space-y-1"></div>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-view" class="hidden fade-in">
            <h2 class="text-2xl font-bold mb-6 ui-element">Results</h2>
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </main>

    <!-- ARTICLE PANEL -->
    <div id="overlay" onclick="closeArticle()"></div>
    
    <div id="article-panel">
        <!-- Game HUD -->
        <div id="game-hud" class="hidden p-3 flex justify-between items-center text-white shrink-0 shadow-md z-20 ui-element">
            <div class="flex flex-col">
                <span class="text-[10px] uppercase opacity-80 font-bold">Target</span>
                <span id="hud-target" class="font-bold leading-none text-lg">...</span>
            </div>
            <div class="flex items-center gap-4 text-sm">
                <div class="text-center"><span class="block text-[10px] opacity-80">Clicks</span><b id="hud-clicks" class="text-lg">0</b></div>
                <div class="text-center"><span class="block text-[10px] opacity-80">Time</span><b id="hud-timer" class="text-lg font-mono">00:00</b></div>
                <button onclick="quitGame()" class="bg-white/20 p-1.5 rounded hover:bg-white/30 active:bg-white/40"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- Toolbar -->
        <div id="reader-toolbar" class="h-14 flex items-center justify-between px-4 border-b border-[var(--border)] bg-[var(--bg-card)] shrink-0 z-10 ui-element">
            <button onclick="closeArticle()" class="flex items-center gap-2 text-[var(--text-secondary)] hover:text-[var(--text-primary)] active:opacity-50">
                <i data-lucide="arrow-left" class="w-5 h-5"></i> Back
            </button>
            <div class="flex gap-2">
                <button onclick="toggleSpeech()" id="tts-btn" class="flex items-center gap-2 px-3 py-1.5 bg-[var(--bg-main)] hover:bg-[var(--accent-soft)] text-[var(--text-secondary)] hover:text-[var(--accent)] active:scale-95 rounded-full transition-all text-sm font-medium">
                    <i data-lucide="volume-2" class="w-4 h-4"></i> <span id="tts-label">Listen</span>
                </button>
                <a id="ext-link" href="#" target="_blank" class="p-2 text-[var(--text-secondary)] hover:bg-[var(--bg-main)] hover:text-[var(--accent)] rounded-full" title="Original">
                    <i data-lucide="external-link" class="w-5 h-5"></i>
                </a>
            </div>
        </div>

        <!-- Article Content -->
        <div id="article-scroll" class="flex-1 overflow-y-auto bg-[var(--bg-card)] relative scroll-smooth">
            <!-- Hero -->
            <div id="article-hero" class="hidden w-full h-72 relative shrink-0">
                <img id="article-hero-img" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[var(--bg-card)] to-transparent"></div>
            </div>

            <!-- Loader -->
            <div id="loader" class="flex flex-col items-center justify-center py-20">
                <div class="w-10 h-10 border-4 border-[var(--accent)] border-t-transparent rounded-full animate-spin"></div>
            </div>

            <!-- Container -->
            <div id="article-container" class="hidden pb-20">
                <!-- Header -->
                <div class="px-6 md:px-10 pt-8 pb-4 max-w-4xl mx-auto">
                    <h1 id="article-title" class="text-3xl md:text-5xl font-bold mb-6 leading-tight"></h1>
                    <!-- AI Summary -->
                    <div class="bg-[var(--accent-soft)] border border-[var(--accent)]/20 rounded-xl p-5 mb-8">
                        <div class="flex items-center justify-between mb-2 ui-element">
                            <span class="text-xs font-bold text-[var(--accent)] uppercase tracking-wider flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Summary
                            </span>
                            <span class="text-xs font-medium text-[var(--text-secondary)] flex items-center gap-1">
                                <i data-lucide="clock" class="w-3 h-3"></i> <span id="read-time">-- min</span>
                            </span>
                        </div>
                        <p id="ai-summary" class="text-[var(--text-primary)] text-sm leading-relaxed opacity-90"></p>
                    </div>
                </div>

                <!-- Body -->
                <div id="article-body" class="wiki-content max-w-4xl mx-auto px-2 md:px-6"></div>
            </div>
        </div>
    </div>

    <!-- GAME MODAL -->
    <div id="game-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden ui-element">
        <div class="bg-[var(--bg-card)] border border-[var(--border)] p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center mx-4">
            <div class="w-14 h-14 bg-[var(--accent)] rounded-2xl flex items-center justify-center mx-auto mb-4 text-white shadow-lg rotate-3">
                <i data-lucide="trophy" class="w-7 h-7"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Wiki Game</h2>
            <p class="text-[var(--text-secondary)] text-sm mb-6">Navigate links from <b>Start</b> to <b>Target</b>.</p>
            
            <div class="bg-[var(--bg-main)] rounded-xl p-4 mb-6 text-left border border-[var(--border)] space-y-2">
                <div class="flex justify-between"><span class="text-xs font-bold opacity-50">START</span><span id="game-start-t" class="font-bold text-sm truncate w-32 text-right">...</span></div>
                <div class="h-px bg-[var(--border)]"></div>
                <div class="flex justify-between"><span class="text-xs font-bold opacity-50">TARGET</span><span id="game-target-t" class="font-bold text-sm truncate w-32 text-right text-[var(--accent)]">...</span></div>
            </div>

            <button id="start-game-btn" onclick="startGame()" class="w-full py-3.5 bg-[var(--accent)] text-white font-bold rounded-xl hover:opacity-90 active:scale-95 transition-all disabled:opacity-50" disabled>Start Game</button>
            <button onclick="document.getElementById('game-modal').classList.add('hidden')" class="mt-4 text-sm text-[var(--text-secondary)] font-medium active:opacity-50">Cancel</button>
        </div>
    </div>

    <script>
        // --- INIT & THEMES ---
        lucide.createIcons();
        const searchInput = document.getElementById('search-input');
        
        let featuredTitle = "";
        let themes = ['light', 'dark', 'sepia'];
        let themeColors = ['#ffffff', '#1e293b', '#fdf6e3']; // For meta theme-color
        let themeIdx = 0;
        let confettiFired = false;

        // State
        let gameState = { active: false, start: null, target: null, clicks: 0, startTime: 0, timer: null };
        let ttsData = { queue: [], index: 0, active: false };

        function cycleTheme() {
            themeIdx = (themeIdx + 1) % themes.length;
            document.body.setAttribute('data-theme', themes[themeIdx]);
            // Update Browser Address Bar Color for Native Feel
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            if(!metaTheme) {
                metaTheme = document.createElement('meta');
                metaTheme.name = "theme-color";
                document.head.appendChild(metaTheme);
            }
            metaTheme.content = themeColors[themeIdx];
        }
        cycleTheme(); // Init light mode color

        // --- DASHBOARD ---
        async function loadDashboard() {
            const now = new Date();
            const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');

            // Featured
            try {
                const fData = await fetch(`https://api.wikimedia.org/feed/v1/wikipedia/en/featured/${y}/${m}/${d}`).then(r=>r.json());
                if(fData.tfa) {
                    document.getElementById('featured-section').classList.remove('hidden');
                    document.getElementById('featured-title').innerHTML = fData.tfa.titles.display;
                    document.getElementById('featured-extract').textContent = fData.tfa.extract;
                    if(fData.tfa.thumbnail) document.getElementById('featured-img').src = fData.tfa.thumbnail.source;
                    featuredTitle = fData.tfa.titles.normalized;
                }
            } catch(e){}

            // Trending
            try {
                const yd = new Date(); yd.setDate(yd.getDate()-1);
                const yy = yd.getFullYear(), ym = String(yd.getMonth()+1).padStart(2,'0'), ydd = String(yd.getDate()).padStart(2,'0');
                const tData = await fetch(`https://wikimedia.org/api/rest_v1/metrics/pageviews/top/en.wikipedia/all-access/${yy}/${ym}/${ydd}`).then(r=>r.json());
                const items = tData.items[0].articles.filter(a=>a.article!=="Main_Page" && !a.article.startsWith("Special:")).slice(0,6);
                const grid = document.getElementById('trending-grid'); grid.innerHTML = '';
                items.forEach(i => {
                    grid.innerHTML += `
                        <div onclick="loadArticle('${i.article.replace(/'/g,"\\'")}')" class="bg-[var(--bg-card)] border border-[var(--border)] p-4 rounded-2xl active:scale-95 transition-transform cursor-pointer">
                            <div class="font-bold text-[var(--text-primary)] truncate">${i.article.replace(/_/g,' ')}</div>
                            <div class="text-xs text-[var(--text-secondary)] mt-1">${(i.views/1000).toFixed(1)}k views</div>
                        </div>`;
                });
            } catch(e){}

            // OTD
            try {
                const oData = await fetch(`https://api.wikimedia.org/feed/v1/wikipedia/en/onthisday/events/${m}/${d}`).then(r=>r.json());
                const list = document.getElementById('otd-list'); list.innerHTML = '';
                oData.events.slice(0,5).forEach(e => {
                    const page = e.pages && e.pages[0] ? e.pages[0].title : null;
                    list.innerHTML += `<div class="flex gap-3 p-3 rounded-xl active:bg-[var(--border)] transition-colors cursor-pointer" ${page ? `onclick="loadArticle('${page.replace(/'/g,"\\'")}')"` : ''}>
                        <span class="font-bold text-[var(--accent)] text-sm min-w-[3rem]">${e.year}</span>
                        <span class="text-sm text-[var(--text-secondary)] line-clamp-2">${e.text}</span>
                    </div>`;
                });
            } catch(e){}
        }
        loadDashboard();

        // --- SEARCH ---
        let sTimer;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(sTimer);
            if(e.target.value.trim()) sTimer = setTimeout(()=>doSearch(e.target.value),500);
            else resetHome();
        });
        function resetHome() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('search-view').classList.add('hidden');
        }
        async function doSearch(q) {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('search-view').classList.remove('hidden');
            const data = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(q)}&format=json&origin=*&srlimit=12`).then(r=>r.json());
            const grid = document.getElementById('results-grid'); grid.innerHTML = '';
            data.query.search.forEach(r => {
                grid.innerHTML += `<div onclick="loadArticle('${r.title.replace(/'/g,"\\'")}')" class="bg-[var(--bg-card)] p-5 rounded-2xl border border-[var(--border)] active:scale-95 transition-transform cursor-pointer">
                    <h3 class="font-bold text-[var(--accent)] mb-2">${r.title}</h3>
                    <p class="text-sm text-[var(--text-secondary)] line-clamp-3">${r.snippet.replace(/<[^>]*>/g,'')}</p>
                </div>`;
            });
        }

        // --- ARTICLE ENGINE ---
        function openFeatured(){ if(featuredTitle) loadArticle(featuredTitle); }
        async function fetchRandom() {
             const r = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*').then(r=>r.json());
             loadArticle(r.query.random[0].title);
        }

        async function loadArticle(title) {
            // Native History Support for Back Button
            history.pushState({ articleOpen: true }, null, "");

            // UI Reset
            document.getElementById('overlay').classList.add('active');
            document.getElementById('article-panel').classList.add('open');
            document.body.style.overflow = 'hidden';
            document.getElementById('article-container').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('article-hero').classList.add('hidden');
            document.getElementById('article-scroll').scrollTop = 0;
            confettiFired = false;
            stopSpeech();

            try {
                const meta = await fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=extracts|pageimages|info&inprop=url&pithumbsize=1000&explaintext&exintro&format=json&origin=*`).then(r=>r.json());
                const pageId = Object.keys(meta.query.pages)[0];
                if(pageId === "-1") throw new Error("Missing");
                const info = meta.query.pages[pageId];

                document.getElementById('article-title').innerHTML = info.title;
                document.getElementById('ai-summary').textContent = info.extract || "No summary available.";
                document.getElementById('ext-link').href = info.fullurl;
                
                if(info.thumbnail) {
                    document.getElementById('article-hero-img').src = info.thumbnail.source;
                    document.getElementById('article-hero').classList.remove('hidden');
                }

                const parseData = await fetch(`https://en.wikipedia.org/w/api.php?action=parse&pageid=${pageId}&prop=text&mobileformat=true&format=json&origin=*`).then(r=>r.json());
                const rawHTML = parseData.parse.text['*'];

                const wc = rawHTML.replace(/<[^>]*>/g, '').split(/\s+/).length;
                document.getElementById('read-time').innerText = Math.ceil(wc / 220) + " min read";

                const temp = document.createElement('div');
                temp.innerHTML = rawHTML;
                temp.querySelectorAll('.mw-editsection, .reference, .noprint, .hatnote, .infobox, .sidebar, style, script').forEach(e=>e.remove());
                temp.querySelectorAll('img').forEach(img => { if(img.src.startsWith('//')) img.src = 'https:'+img.src; });

                const body = document.getElementById('article-body');
                body.innerHTML = '';
                
                const introDiv = document.createElement('div');
                introDiv.className = 'px-4 pb-6';
                body.appendChild(introDiv);
                let current = introDiv;

                Array.from(temp.childNodes).forEach(node => {
                    if(node.tagName === 'H2') {
                        const d = document.createElement('details');
                        const s = document.createElement('summary');
                        s.innerText = node.innerText;
                        const c = document.createElement('div');
                        c.className = 'details-content';
                        d.appendChild(s); d.appendChild(c);
                        body.appendChild(d);
                        current = c;
                    } else {
                        current.appendChild(node.cloneNode(true));
                    }
                });

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('article-container').classList.remove('hidden');

            } catch(e) {
                window.open(`https://en.wikipedia.org/wiki/${encodeURIComponent(title)}`, '_blank');
                closeArticle();
            }
        }

        // --- NATIVE BACK BUTTON HANDLER ---
        window.addEventListener('popstate', (event) => {
            // If we popped state and article is open, close it
            if (document.getElementById('article-panel').classList.contains('open')) {
                closeArticle(true); // true = from history
            }
        });

        function closeArticle(fromHistory = false) {
            if(gameState.active && !confirm("Quit game?")) {
                // If user cancels quit, and it came from back button, push state back
                if(fromHistory) history.pushState({ articleOpen: true }, null, "");
                return;
            }
            if(gameState.active) quitGame();

            // If closing manually (not from back button), go back in history to keep sync
            if (!fromHistory && history.state && history.state.articleOpen) {
                history.back();
                return; // The popstate event will trigger the actual UI close
            }
            
            document.getElementById('article-panel').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
            document.body.style.overflow = 'auto';
            stopSpeech();
        }

        // --- LINKS ---
        document.getElementById('article-body').addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if(link) {
                const href = link.getAttribute('href');
                if(href && href.startsWith('/wiki/')) {
                    e.preventDefault();
                    const nextTitle = decodeURIComponent(href.split('/wiki/')[1]);
                    
                    if(gameState.active) {
                        gameState.clicks++;
                        document.getElementById('hud-clicks').innerText = gameState.clicks;
                        if(nextTitle.toLowerCase().replace(/_/g,' ') === gameState.target.toLowerCase().replace(/_/g,' ')) {
                            endGame(true);
                        }
                    }
                    loadArticle(nextTitle);
                }
            }
        });

        // --- TTS ---
        function toggleSpeech() {
            ttsData.active ? stopSpeech() : startSpeech();
        }
        function startSpeech() {
            ttsData.active = true;
            updateTTSUI();
            const fullText = document.getElementById('ai-summary').innerText + " " + document.getElementById('article-body').innerText;
            ttsData.queue = fullText.match(/[^.!?]+[.!?]+/g) || [fullText];
            ttsData.index = 0;
            speakNextChunk();
        }
        function speakNextChunk() {
            if(!ttsData.active || ttsData.index >= ttsData.queue.length) { stopSpeech(); return; }
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(ttsData.queue[ttsData.index]);
            ut.onend = () => { if(ttsData.active) { ttsData.index++; speakNextChunk(); }};
            ut.onerror = () => { ttsData.index++; speakNextChunk(); };
            window.speechSynthesis.speak(ut);
        }
        function stopSpeech() {
            ttsData.active = false;
            window.speechSynthesis.cancel();
            updateTTSUI();
        }
        function updateTTSUI() {
            const btn = document.getElementById('tts-btn');
            const lbl = document.getElementById('tts-label');
            if(ttsData.active) {
                btn.classList.add('bg-red-50', 'text-red-600');
                lbl.innerText = "Stop";
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> <span id="tts-label">Stop</span>`;
            } else {
                btn.classList.remove('bg-red-50', 'text-red-600');
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg> <span id="tts-label">Listen</span>`;
            }
        }

        // --- SCROLL REWARD ---
        document.getElementById('article-scroll').addEventListener('scroll', (e) => {
            const t = e.target;
            if(t.scrollTop + t.clientHeight >= t.scrollHeight - 50 && !confettiFired && !gameState.active) {
                confettiFired = true;
                confetti({ particleCount: 100, origin: { y: 0.8 } });
            }
        });

        // --- GAME ---
        async function openGameMenu() {
            document.getElementById('game-modal').classList.remove('hidden');
            document.getElementById('start-game-btn').disabled = true;
            document.getElementById('game-start-t').innerText = "Rolling...";
            document.getElementById('game-target-t').innerText = "Rolling...";
            
            const r1 = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*').then(r=>r.json());
            const r2 = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*').then(r=>r.json());
            gameState.start = r1.query.random[0].title;
            gameState.target = r2.query.random[0].title;
            document.getElementById('game-start-t').innerText = gameState.start;
            document.getElementById('game-target-t').innerText = gameState.target;
            document.getElementById('start-game-btn').disabled = false;
        }
        function startGame() {
            document.getElementById('game-modal').classList.add('hidden');
            gameState.active = true;
            gameState.clicks = 0;
            gameState.startTime = Date.now();
            document.getElementById('game-hud').classList.remove('hidden');
            document.getElementById('reader-toolbar').classList.add('hidden');
            document.getElementById('hud-target').innerText = gameState.target;
            document.getElementById('hud-clicks').innerText = "0";
            if(gameState.timer) clearInterval(gameState.timer);
            gameState.timer = setInterval(() => {
                const diff = Math.floor((Date.now() - gameState.startTime)/1000);
                const m = String(Math.floor(diff/60)).padStart(2,'0'), s = String(diff%60).padStart(2,'0');
                document.getElementById('hud-timer').innerText = `${m}:${s}`;
            }, 1000);
            loadArticle(gameState.start);
        }
        function endGame(win) {
            clearInterval(gameState.timer);
            gameState.active = false;
            if(win) {
                confetti({ particleCount: 300, spread: 100 });
                alert(`ðŸŽ‰ VICTORY!\n\nTarget: ${gameState.target}\nClicks: ${gameState.clicks}\nTime: ${document.getElementById('hud-timer').innerText}`);
            }
            quitGame();
        }
        function quitGame() {
            clearInterval(gameState.timer);
            gameState.active = false;
            document.getElementById('game-hud').classList.add('hidden');
            document.getElementById('reader-toolbar').classList.remove('hidden');
            closeArticle();
        }
    </script>
</body>
</html>
